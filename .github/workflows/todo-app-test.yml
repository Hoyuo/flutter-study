name: Todo App - Test & Coverage

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main, develop]
    paths:
      - 'examples/todo_app/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'examples/todo_app/**'

defaults:
  run:
    working-directory: examples/todo_app

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap
        run: melos bootstrap

      - name: Run Tests with Coverage
        run: melos exec -- "flutter test --coverage"

      - name: Install lcov
        run: sudo apt-get install -y lcov

      - name: Merge Coverage Reports
        run: |
          mkdir -p coverage
          lcov --add-tracefile packages/core/coverage/lcov.info \
               --add-tracefile packages/task/coverage/lcov.info \
               --add-tracefile packages/category/coverage/lcov.info \
               --add-tracefile packages/settings/coverage/lcov.info \
               -o coverage/merged.info

      - name: Check Coverage Threshold
        env:
          COVERAGE_THRESHOLD: 80.0
        run: |
          COVERAGE=$(lcov --summary coverage/merged.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+' | head -1)
          echo "Coverage: $COVERAGE%"
          echo "Threshold: $COVERAGE_THRESHOLD%"

          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "::error::Coverage is $COVERAGE%, required minimum $COVERAGE_THRESHOLD%"
            exit 1
          fi

          echo "::notice::Coverage check passed: $COVERAGE% (threshold: $COVERAGE_THRESHOLD%)"

      - name: Coverage Report Summary
        run: |
          echo "## Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|" >> $GITHUB_STEP_SUMMARY

          for pkg in packages/core packages/task packages/category packages/settings; do
            if [ -f "$pkg/coverage/lcov.info" ]; then
              COV=$(lcov --summary "$pkg/coverage/lcov.info" 2>&1 | grep "lines" | grep -oP '\d+\.\d+' | head -1)
              PKG_NAME=$(basename $pkg)
              echo "| $PKG_NAME | $COV% |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          TOTAL=$(lcov --summary coverage/merged.info 2>&1 | grep "lines" | grep -oP '\d+\.\d+' | head -1)
          echo "| **Total** | **$TOTAL%** |" >> $GITHUB_STEP_SUMMARY
